# üìã Conven√ß√µes de C√≥digo - Spdpay Gateway

**Vers√£o:** 1.0.0  
**Status:** Obrigat√≥rio üö®  
**Data:** 2025-10-29

Este documento define os padr√µes t√©cnicos e de arquitetura do Spdpay Gateway.
Toda nova funcionalidade dever√° respeitar estas regras.

---

## üß† Filosofia

- **Simplicidade antes de complexidade**
- **Cada pe√ßa com uma responsabilidade clara**
- **Falhar com clareza √© melhor do que mascarar o erro**
- **Nenhum dado sens√≠vel de cart√£o no nosso banco ‚Äî nunca**

---

## üèó Estrutura de Pastas

```
spdpay-gateway/
‚îú‚îÄ src/
‚îÇ  ‚îú‚îÄ api/            # Endpoints FastAPI
‚îÇ  ‚îÇ  ‚îú‚îÄ v1/          # Vers√£o 1 da API
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ __init__.py
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ invoices.py
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ payments.py
‚îÇ  ‚îÇ  ‚îÇ  ‚îú‚îÄ cards.py
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ webhooks.py
‚îÇ  ‚îÇ  ‚îú‚îÄ dependencies.py  # Auth e valida√ß√µes
‚îÇ  ‚îÇ  ‚îî‚îÄ health.py
‚îÇ  ‚îú‚îÄ services/       # L√≥gica de neg√≥cio (core payments)
‚îÇ  ‚îÇ  ‚îú‚îÄ invoice_service.py
‚îÇ  ‚îÇ  ‚îú‚îÄ payment_service.py
‚îÇ  ‚îÇ  ‚îî‚îÄ webhook_service.py
‚îÇ  ‚îú‚îÄ schemas/        # Pydantic models (request/response)
‚îÇ  ‚îÇ  ‚îú‚îÄ invoice.py
‚îÇ  ‚îÇ  ‚îú‚îÄ payment.py
‚îÇ  ‚îÇ  ‚îú‚îÄ card.py
‚îÇ  ‚îÇ  ‚îî‚îÄ webhook.py
‚îÇ  ‚îú‚îÄ adapters/       # Clientes externos (Adiq)
‚îÇ  ‚îÇ  ‚îî‚îÄ adiq.py
‚îÇ  ‚îú‚îÄ models/         # Domain models (DB entities)
‚îÇ  ‚îÇ  ‚îú‚îÄ invoice.py
‚îÇ  ‚îÇ  ‚îú‚îÄ transaction.py
‚îÇ  ‚îÇ  ‚îú‚îÄ customer.py
‚îÇ  ‚îÇ  ‚îú‚îÄ merchant.py
‚îÇ  ‚îÇ  ‚îî‚îÄ card.py
‚îÇ  ‚îú‚îÄ core/           # Config, auth, utils globais
‚îÇ  ‚îÇ  ‚îú‚îÄ config.py
‚îÇ  ‚îÇ  ‚îú‚îÄ logger.py
‚îÇ  ‚îÇ  ‚îú‚îÄ security.py
‚îÇ  ‚îÇ  ‚îú‚îÄ state_machine.py
‚îÇ  ‚îÇ  ‚îî‚îÄ exceptions.py
‚îÇ  ‚îú‚îÄ db/             # Supabase storage layer
‚îÇ  ‚îÇ  ‚îú‚îÄ schemas.py
‚îÇ  ‚îÇ  ‚îî‚îÄ client.py
‚îÇ  ‚îî‚îÄ main.py
‚îú‚îÄ tests/
‚îÇ  ‚îú‚îÄ unit/
‚îÇ  ‚îú‚îÄ integration/
‚îÇ  ‚îú‚îÄ certification/
‚îÇ  ‚îî‚îÄ fixtures/
‚îú‚îÄ docs/
‚îî‚îÄ ops/               # Infra (Docker, Render configs)
```

---

## üìå Princ√≠pios de Arquitetura

### API "magra", Services "gordos"

**Endpoints s√≥ validam entrada e chamam servi√ßo.**

```python
# ‚úÖ Correto
@router.post("/invoices")
async def create_invoice(data: InvoiceCreateRequest):
    return await invoice_service.create(data)

# ‚ùå Errado - l√≥gica no endpoint
@router.post("/invoices")
async def create_invoice(data: InvoiceCreateRequest):
    # valida√ß√µes complexas aqui
    # chamadas ao banco aqui
    # l√≥gica de neg√≥cio aqui
```

### Separa√ß√£o de Responsabilidades

- **API Layer**: Valida√ß√£o de entrada, autentica√ß√£o, serializa√ß√£o
- **Service Layer**: L√≥gica de neg√≥cio, orquestra√ß√£o, transa√ß√µes
- **Adapter Layer**: Comunica√ß√£o com servi√ßos externos (Adiq)
- **Model Layer**: Representa√ß√£o de dados, persist√™ncia

---

## üîê PCI e Seguran√ßa

### Regra Suprema

**‚úÖ Nunca armazenar:**
- PAN (n√∫mero do cart√£o)
- CVV
- Data de validade
- Nome impresso no cart√£o

**‚úÖ Apenas permitido:**
- Token/vaultId da Adiq
- Brand (bandeira)
- Last4 (√∫ltimos 4 d√≠gitos)

### Diretrizes de Seguran√ßa

| Item | Status | Observa√ß√£o |
|------|--------|------------|
| TLS obrigat√≥rio | ‚úÖ | Render cuida |
| Adiq tokens sempre em mem√≥ria curta | ‚úÖ | Nunca persistir |
| Nunca logar payload de cart√£o | ‚úÖ | Sanitizar logs |
| Chaves mascaradas em logs | ‚úÖ | `****1234` |
| API Keys por Merchant | ‚úÖ | Obrigat√≥rio |

### Exemplo de Log Seguro

```python
# ‚ùå NUNCA fazer isso
logger.info(f"Card: {card_number}")

# ‚úÖ Correto
logger.info(f"Card tokenized: {token_id}, last4: {last4}")
```

---

## üß© Tamanho e Organiza√ß√£o do C√≥digo

| Item | Limite | Observa√ß√£o |
|------|--------|------------|
| Endpoint | ‚â§ 80 linhas | Apenas valida√ß√£o |
| Service | ‚â§ 300 linhas | Cora√ß√£o do dom√≠nio |
| Adapter Adiq | ‚â§ 200 linhas | Conex√£o externa |
| Schemas | ‚â§ 100 linhas | Simples |
| Arquivo no geral | ‚â§ 400 linhas | Fragmentar quando necess√°rio |

---

## üôÖ‚Äç‚ôÇÔ∏è Regras de Erros (CR√çTICAS PARA CART√ÉO)

### ‚ùå Proibido

```python
# NUNCA fazer isso
try:
    payment = process_payment()
except:
    pass  # ‚ùå Silenciar erro de pagamento

# NUNCA fazer isso
def process_payment():
    try:
        # ...
        return None  # ‚ùå Retornar None em pagamento
    except:
        return None
```

### ‚úÖ Obrigat√≥rio

```python
# ‚úÖ Correto - logar e propagar
try:
    token = await adiq_client.authenticate()
except Exception as e:
    logger.error(
        "adiq_auth_failed",
        error=str(e),
        merchant_id=merchant_id
    )
    raise HTTPException(
        status_code=502,
        detail="Falha na comunica√ß√£o com Adiq"
    )

# ‚úÖ Logs devem ter ID da invoice/transaction
logger.info(
    "payment_processed",
    invoice_id=invoice.id,
    transaction_id=transaction.id,
    amount=amount
)
```

---

## üì° Webhooks

### Regras Obrigat√≥rias

1. **Sempre idempotentes**: Processar o mesmo webhook m√∫ltiplas vezes n√£o deve causar efeitos colaterais
2. **Registrar evento antes de processar**: Salvar webhook_log primeiro
3. **Atualiza√ß√£o de status somente se permitido**: Validar transi√ß√£o de estado
4. **Proibido reprocessar sucesso ‚Üí sucesso**

```python
# ‚úÖ Correto
async def process_webhook(webhook_data: dict):
    # 1. Registrar recebimento
    webhook_log = await save_webhook_log(webhook_data)
    
    # 2. Verificar se j√° foi processado (idempot√™ncia)
    if webhook_log.processed:
        return {"status": "already_processed"}
    
    # 3. Validar transi√ß√£o de estado
    if not can_transition(current_status, new_status):
        raise InvalidStateTransition()
    
    # 4. Processar
    await update_transaction_status(new_status)
    
    # 5. Marcar como processado
    await mark_webhook_processed(webhook_log.id)
```

---

## üß± Dom√≠nio de Pagamentos ‚Äî Estados Permitidos

### Invoice Status

```
PENDING ‚Üí PROCESSING ‚Üí PAID
         PROCESSING ‚Üí FAILED
```

### Transaction Status

```
CREATED ‚Üí AUTHORIZED ‚Üí CAPTURED ‚Üí SETTLED
CREATED ‚Üí DECLINED
AUTHORIZED ‚Üí CANCELLED
```

### ‚ùå Nunca Permitir

- `PAID ‚Üí PENDING` (reverter status)
- Pular etapas de transa√ß√£o
- Transi√ß√µes n√£o mapeadas

### Implementa√ß√£o

```python
# core/state_machine.py
ALLOWED_TRANSITIONS = {
    "Invoice": {
        "PENDING": ["PROCESSING"],
        "PROCESSING": ["PAID", "FAILED"],
        "PAID": [],  # Estado final
        "FAILED": []  # Estado final
    },
    "Transaction": {
        "CREATED": ["AUTHORIZED", "DECLINED"],
        "AUTHORIZED": ["CAPTURED", "CANCELLED"],
        "CAPTURED": ["SETTLED"],
        "SETTLED": [],  # Estado final
        "DECLINED": [],  # Estado final
        "CANCELLED": []  # Estado final
    }
}

def can_transition(entity_type: str, from_status: str, to_status: str) -> bool:
    allowed = ALLOWED_TRANSITIONS.get(entity_type, {}).get(from_status, [])
    return to_status in allowed
```

---

## üìö Idioma e Docstrings

### Padr√µes

- ‚úÖ **Docstrings em ingl√™s**
- ‚úÖ **Coment√°rios de regra de neg√≥cio podem ser PT-BR**
- ‚úÖ **Nomes de vari√°veis em ingl√™s**
- ‚úÖ **Logs em ingl√™s**

```python
# ‚úÖ Correto
async def create_invoice(data: InvoiceCreateRequest) -> Invoice:
    """
    Create a new invoice for a merchant.
    
    Args:
        data: Invoice creation request data
        
    Returns:
        Created invoice instance
        
    Raises:
        InvalidMerchantError: If merchant is not active
    """
    # Regra de neg√≥cio: faturas s√≥ podem ser criadas para merchants ativos
    if not merchant.is_active:
        raise InvalidMerchantError()
```

---

## ‚úÖ Testes

### Cobertura Obrigat√≥ria

| Tipo | Obrigat√≥rio | Cobertura M√≠nima |
|------|-------------|------------------|
| Services de pagamento | ‚úÖ | 80% |
| Adapter Adiq | ‚úÖ | 70% |
| Webhooks | ‚úÖ | 80% |
| Valida√ß√£o de schemas | ‚úÖ | 90% |
| Endpoints | ‚úÖ | 70% |
| Banco/Supabase | Parcial ‚ö†Ô∏è | 50% |

**Cobertura m√≠nima geral: >70%**

### Estrutura de Testes

```python
# tests/unit/test_payment_service.py
import pytest
from src.services.payment_service import PaymentService

@pytest.mark.asyncio
async def test_create_payment_success():
    """Test successful payment creation"""
    # Arrange
    service = PaymentService()
    data = create_test_payment_data()
    
    # Act
    result = await service.create_payment(data)
    
    # Assert
    assert result.status == "CREATED"
    assert result.amount == data.amount
```

---

## üöÄ Performance

### Regras

1. **Todas as chamadas para Adiq: async**
2. **Webhook r√°pido ‚Üí colocar longo em task (futuro)**
3. **Rate-limiting por merchant**
4. **Connection pooling para Supabase**

```python
# ‚úÖ Correto - async
async def tokenize_card(card_data: dict) -> str:
    async with httpx.AsyncClient() as client:
        response = await client.post(url, json=card_data)
        return response.json()["token"]

# ‚ùå Errado - sync
def tokenize_card(card_data: dict) -> str:
    response = requests.post(url, json=card_data)
    return response.json()["token"]
```

---

## ‚úÖ Code Review Checklist

Antes de fazer merge, verificar:

- [ ] Nenhum dado de cart√£o no banco
- [ ] Logs estruturados e sanitizados
- [ ] Exce√ß√µes espec√≠ficas (n√£o gen√©ricas)
- [ ] Testes cobrindo caminhos cr√≠ticos
- [ ] Rotas organizadas por dom√≠nio
- [ ] Transi√ß√µes de status v√°lidas
- [ ] Docstrings em ingl√™s
- [ ] Type hints em todas as fun√ß√µes
- [ ] Async onde necess√°rio
- [ ] Sem hardcoded secrets

---

## üîß Ferramentas Obrigat√≥rias

### Formata√ß√£o e Linting

```bash
# Black - formata√ß√£o
black src/ tests/

# Ruff - linting
ruff check src/ tests/

# isort - ordena√ß√£o de imports
isort src/ tests/

# mypy - type checking (parcial)
mypy src/ --ignore-missing-imports
```

### Pre-commit Hook

```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.3.0
    hooks:
      - id: black
  - repo: https://github.com/charliermarsh/ruff-pre-commit
    rev: v0.0.270
    hooks:
      - id: ruff
```

---

## üö´ Preven√ß√£o de Duplica√ß√£o de C√≥digo

### Regra Cr√≠tica: Verificar Antes de Criar

**Antes de criar qualquer arquivo, fun√ß√£o ou classe, SEMPRE:**

1. **Buscar primeiro** - Use grep/search para verificar se j√° existe
2. **Consultar estrutura** - Verifique este documento e a √°rvore de pastas
3. **Reutilizar** - Prefira estender c√≥digo existente a duplicar

### Checklist Obrigat√≥rio

```bash
# 1. Buscar se j√° existe
grep -r "class PaymentService" src/
grep -r "def process_payment" src/

# 2. Verificar estrutura de pastas
ls -la src/services/

# 3. Se existir, reutilizar ou estender
# Se n√£o existir, criar no lugar correto conforme estrutura
```

### Arquivos √önicos (Nunca Duplicar)

| Arquivo | Localiza√ß√£o | Prop√≥sito |
|---------|-------------|-----------|
| `README.md` | Raiz | Apresenta√ß√£o do projeto |
| `ROADMAP.md` | Raiz | Planejamento de fases |
| `CONVENTIONS.md` | Raiz | Este documento |
| `SECURITY.md` | Raiz | Pol√≠tica de seguran√ßa |
| `CONTRIBUTING.md` | Raiz | Guia de contribui√ß√£o |
| `docs/README.md` | docs/ | √çndice da documenta√ß√£o |
| `main.py` | src/ | Entry point da aplica√ß√£o |
| `config.py` | src/core/ | Configura√ß√µes centralizadas |

### Padr√£o de Nomenclatura

```python
# ‚úÖ Correto - Nome √∫nico e descritivo
class AdiqPaymentAdapter:
    pass

# ‚ùå Errado - Nome gen√©rico que pode duplicar
class Adapter:
    pass

# ‚úÖ Correto - Fun√ß√£o espec√≠fica
def validate_credit_card_payment(data: dict) -> bool:
    pass

# ‚ùå Errado - Fun√ß√£o gen√©rica
def validate(data: dict) -> bool:
    pass
```

### Antes de Fazer PR

- [ ] Busquei por c√≥digo similar
- [ ] Verifiquei a estrutura de pastas
- [ ] N√£o criei arquivos duplicados
- [ ] Segui a nomenclatura padr√£o
- [ ] Consultei CONVENTIONS.md

---

## üî• Conclus√£o

Este documento est√°:
- ‚úÖ 100% alinhado ao contexto de pagamentos
- ‚úÖ Sint√©tico mas completo
- ‚úÖ Excelente para refer√™ncia durante desenvolvimento
- ‚úÖ Preparado para a constru√ß√£o do gateway
- ‚úÖ Com regras de preven√ß√£o de duplica√ß√£o

**Sempre consulte este documento antes de implementar novas features.**
